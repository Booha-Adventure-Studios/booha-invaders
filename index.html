<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Booha Invaders â€” Stage 1 DOTTY</title>
<style>
html,body{
  margin:0;
  height:100%;
  background:#000;
  overflow:hidden;
}
canvas{
  display:block;
  width:100vw;
  height:100vh;
  touch-action:none;
}
</style>
</head>
<body>
<canvas id="c"></canvas>

<script>
(() => {
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d",{alpha:false});

const DPR_CAP = 2;
let DPR=1;
function resize(){
  DPR=Math.min(devicePixelRatio||1,DPR_CAP);
  canvas.width=innerWidth*DPR;
  canvas.height=innerHeight*DPR;
  ctx.setTransform(DPR,0,0,DPR,0,0);
}
addEventListener("resize",resize);

// ---------- Assets ----------
const ASSETS={
  bg:"assets/background.png",
  booIdle:"assets/booha-invad-1.png",
  booShoot:"assets/booha-invad-2.png",
  bug:"assets/bug-1.png",
  candy:"assets/candy.png",
  rocks:[
    "assets/rock1.png",
    "assets/rock2.png",
    "assets/rock3.png",
    "assets/rock4.png"
  ]
};
function load(src){
  return new Promise(res=>{
    const i=new Image();
    i.onload=()=>res(i);
    i.src=src;
  });
}
let IMG={};

// ---------- Helpers ----------
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const rand=(a,b)=>a+Math.random()*(b-a);
const aabb=(ax,ay,aw,ah,bx,by,bw,bh)=>
  ax<bx+bw && ax+aw>bx && ay<by+bh && ay+ah>by;

// ---------- Input ----------
let pointerX=null;
canvas.addEventListener("pointerdown",e=>pointerX=e.clientX);
canvas.addEventListener("pointermove",e=>pointerX=e.clientX);
canvas.addEventListener("pointerup",()=>pointerX=null);
const keys=new Set();
addEventListener("keydown",e=>keys.add(e.key));
addEventListener("keyup",e=>keys.delete(e.key));

// ---------- Player ----------
const player={
  x:0,y:0,w:80,h:80,
  energy:100,
  glow:0,
  fireCooldown:0,
  sugar:0
};

// ---------- World ----------
const rocks=[];
const bugs=[];
const booShots=[];
const bugShots=[];
const sparkles=[];
const candies=[];

// ---------- Stage ----------
let round=0;
let bugsThisRound=1;
let bugsKilled=0;
let spawnDelay=0;
let bugSpeed=10;

// ---------- Setup ----------
function reset(){
  resize();
  player.energy=100;
  player.sugar=0;
  player.fireCooldown=0;
  player.w=clamp(innerWidth*0.12,70,90);
  player.h=player.w;
  player.x=innerWidth/2-player.w/2;
  player.y=innerHeight-player.h-20;

  rocks.length=0;
  for(let i=0;i<4;i++){
    rocks.push({
      x:(i+1)*(innerWidth/5)-50,
      y:player.y-90,
      w:100,h:70,
      hp:20
    });
  }

  bugs.length=0;
  booShots.length=0;
  bugShots.length=0;
  candies.length=0;
  sparkles.length=0;

  round=0;
  nextRound();
}

function nextRound(){
  round++;
  bugsKilled=0;
  if(round===1) bugsThisRound=1;
  else if(round===2) bugsThisRound=2;
  else if(round===3) bugsThisRound=4;
  else if(round===4) bugsThisRound=8;
  else bugsThisRound++;

  spawnDelay=0;
  bugSpeed+=2;
}

function spawnBug(){
  bugs.push({
    x:rand(50,innerWidth-100),
    y:-80,
    w:90,h:90,
    drift:rand(-1,1),
    fireCD:rand(2,4),
    alive:true
  });
}

// ---------- Update ----------
let last=0;
function update(dt){
  if(player.energy<=0) return;

  // movement
  if(pointerX!==null){
    player.x=clamp(pointerX-player.w/2,0,innerWidth-player.w);
  } else {
    if(keys.has("ArrowLeft")) player.x-=400*dt;
    if(keys.has("ArrowRight")) player.x+=400*dt;
  }

  // firing
  player.fireCooldown-=dt;
  const fireRate=player.sugar>0?0.12:0.28;
  if(player.fireCooldown<=0){
    booShots.push({
      x:player.x+player.w/2,
      y:player.y,
      vy:-900
    });
    player.fireCooldown=fireRate;
    player.glow=0.2;
  }

  player.glow=Math.max(0,player.glow-dt);
  player.sugar=Math.max(0,player.sugar-dt);

  // spawn bugs
  spawnDelay-=dt;
  if(bugs.length<bugsThisRound && spawnDelay<=0){
    spawnBug();
    spawnDelay=0.8;
  }

  // bugs
  bugs.forEach(b=>{
    if(!b.alive) return;
    b.y+=40*dt;
    b.x+=Math.sin(Date.now()/1000+b.y)*bugSpeed*dt;
    b.fireCD-=dt;
    if(b.fireCD<=0){
      bugShots.push({
        x:b.x+b.w/2,
        y:b.y+b.h,
        vy:300
      });
      b.fireCD=rand(1.5,3.5);
    }
  });

  // boo shots
  booShots.forEach(s=>{
    s.y+=s.vy*dt;
    sparkles.push({x:s.x,y:s.y,life:0});
    bugs.forEach(b=>{
      if(b.alive && aabb(s.x-4,s.y-4,8,8,b.x,b.y,b.w,b.h)){
        b.alive=false;
        s.dead=true;
        bugsKilled++;
      }
    });
  });

  // bug shots
  bugShots.forEach(s=>{
    s.y+=s.vy*dt;
    if(aabb(s.x-6,s.y-6,12,12,player.x,player.y,player.w,player.h)){
      s.dead=true;
      player.energy-=10;
    }
    rocks.forEach(r=>{
      if(r.hp>0 && aabb(s.x-6,s.y-6,12,12,r.x,r.y,r.w,r.h)){
        r.hp--;
        s.dead=true;
      }
    });
  });

  // cleanup
  booShots.filter(s=>!s.dead && s.y>-20);
  bugShots.filter(s=>!s.dead && s.y<innerHeight+20);
  bugs.filter(b=>b.alive);

  // round clear
  if(bugsKilled>=bugsThisRound){
    dropCandy();
    nextRound();
  }
}

// ---------- Candy ----------
function dropCandy(){
  candies.push({
    x:rand(40,innerWidth-40),
    y:-40,
    vy:80
  });
}

function updateCandy(dt){
  candies.forEach(c=>{
    c.y+=c.vy*dt;
    sparkles.push({x:c.x,y:c.y,life:0});
    if(aabb(c.x-20,c.y-20,40,40,player.x,player.y,player.w,player.h)){
      c.dead=true;
      player.sugar=8;
      player.energy=clamp(player.energy+40,0,100);
    }
  });
  for(let i=candies.length-1;i>=0;i--) if(candies[i].dead) candies.splice(i,1);
}

// ---------- Draw ----------
function draw(){
  ctx.drawImage(IMG.bg,0,0,innerWidth,innerHeight);

  // rocks
  rocks.forEach(r=>{
    if(r.hp<=0) return;
    const idx=clamp(4-Math.ceil(r.hp/5),0,3);
    ctx.drawImage(IMG.rocks[idx],r.x,r.y,r.w,r.h);
  });

  // bugs
  bugs.forEach(b=>{
    if(!b.alive) return;
    ctx.drawImage(IMG.bug,b.x,b.y,b.w,b.h);
  });

  // shots
  ctx.fillStyle="#ffd166";
  booShots.forEach(s=>ctx.fillRect(s.x-2,s.y-8,4,12));
  ctx.fillStyle="#66ff99";
  bugShots.forEach(s=>ctx.fillRect(s.x-4,s.y-4,8,8));

  // candy
  candies.forEach(c=>{
    ctx.drawImage(IMG.candy,c.x-20,c.y-20,40,40);
  });

  // booha
  if(player.energy>0){
    if(player.glow>0){
      ctx.globalAlpha=0.7;
      ctx.beginPath();
      ctx.arc(player.x+player.w/2,player.y+player.h/2,player.w,0,Math.PI*2);
      ctx.fillStyle="#ffd166";
      ctx.fill();
      ctx.globalAlpha=1;
    }
    ctx.drawImage(
      player.fireCooldown<0.15?IMG.booShoot:IMG.booIdle,
      player.x,player.y,player.w,player.h
    );
  }

  // energy meter
  ctx.fillStyle="#000";
  ctx.fillRect(20,20,120,10);
  ctx.fillStyle="#ffd166";
  ctx.fillRect(20,20,120*(player.energy/100),10);
}

// ---------- Loop ----------
function loop(t){
  const dt=Math.min(0.033,(t-last)/1000);
  last=t;
  update(dt);
  updateCandy(dt);
  draw();
  requestAnimationFrame(loop);
}

// ---------- Boot ----------
(async()=>{
  resize();
  const [
    bg,boo1,boo2,bug,candy,
    r1,r2,r3,r4
  ]=await Promise.all([
    load(ASSETS.bg),
    load(ASSETS.booIdle),
    load(ASSETS.booShoot),
    load(ASSETS.bug),
    load(ASSETS.candy),
    load(ASSETS.rocks[0]),
    load(ASSETS.rocks[1]),
    load(ASSETS.rocks[2]),
    load(ASSETS.rocks[3])
  ]);
  IMG={
    bg,
    booIdle:boo1,
    booShoot:boo2,
    bug,
    candy,
    rocks:[r1,r2,r3,r4]
  };
  reset();
  requestAnimationFrame(loop);
})();
})();
</script>
</body>
</html>
